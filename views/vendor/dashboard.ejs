<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° jQuery -->
  <link href="/css/dashboard.css" rel="stylesheet">
  <title><%= title %></title>

</head>
<body>
  <%- include('../partials/navbar') %>
  <main class="container mt-4">
    <h2 class="text-center mb-3">Dashboard ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
  
    <% if (!restaurant) { %>
      <div class="text-center">
        <p>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        <a href="/vendor/create-restaurant" class="btn btn-primary btn-lg">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</a>
      </div>
    <% } else { %>
      <div class="card restaurant-card">
        <div class="card-header bg-primary text-white text-center">
          <h2 class="card-title">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô: <%= restaurant.name %></h2>
        </div>
        <div class="card-body">
          <p><strong>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô:</strong> <%= restaurant.owner_name %></p>
          <p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <%= restaurant.owner_email %></p>
          <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô:</strong> <%= restaurant.owner_tel %></p>
          <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</strong> <%= restaurant.description %></p>
          <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> <%= restaurant.address %></p>
          <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> 
            <span id="restaurant-status" class="status-indicator">
              <%= restaurant.status === "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô" ? "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô üü¢" : "‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô üî¥" %>
            </span>
          </p>

          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞) -->
          <div class="d-grid gap-2">
            <button id="toggle-status-btn" class="btn btn-warning btn-lg"
              onclick="toggleRestaurantStatus('<%= restaurant ? restaurant.restaurant_id : '' %>')">
              <%= restaurant.status === "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô" ? "‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô" : "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô" %>
            </button>
            <a href="/vendor/manage-menu" class="btn btn-success btn-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</a>
            <a href="/vendor/add-menu/<%= restaurant.restaurant_id %>" class="btn btn-primary btn-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</a>
            <a href="/report" class="btn btn-danger btn-lg">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</a>
          </div>
                   <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á QR Code -->
         <% if (restaurant.qrcode_image) { %>
          <button class="btn btn-info btn-lg mt-3" onclick="toggleQRCode()">‡∏î‡∏π QR Code ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</button>
          
          <!-- QR Code ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà -->
          <div id="qr-code-container" class="mt-3" style="display: none;">
            <p><strong>QR Code ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á:</strong></p>
            <img src="<%= restaurant.qrcode_image %>" alt="QR Code ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" class="qr-code-img">
          </div>
        <% } %>
  
        </div>
      </div>
    <% } %>
  </main>
  

  <script>

    document.addEventListener("DOMContentLoaded", () => {
      const restaurantId = "<%= restaurant ? restaurant.restaurant_id : '' %>";
      if (restaurantId !== "") {
        checkRestaurantStatus(restaurantId);
        setInterval(() => { checkRestaurantStatus(restaurantId); }, 5000);
      }
    });

    function toggleQRCode() {
      const qrCodeContainer = document.getElementById("qr-code-container");
      if (qrCodeContainer.style.display === "none") {
        qrCodeContainer.style.display = "block";
      } else {
        qrCodeContainer.style.display = "none";
      }
    }

    function toggleRestaurantStatus(restaurantId) {
      fetch(`/vendor/toggle-status/${restaurantId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const statusElement = document.getElementById("restaurant-status");
          const toggleButton = document.getElementById("toggle-status-btn");

          if (data.newStatus === "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô") {
            statusElement.innerHTML = "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô üü¢";
            toggleButton.innerText = "‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
          } else {
            statusElement.innerHTML = "‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô üî¥";
            toggleButton.innerText = "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
          }

          Swal.fire({
            icon: "success",
            title: "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!",
            text: `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${data.newStatus === "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô" ? "‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß" : "‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß"}`,
            showConfirmButton: false,
            timer: 2000
          });

          checkRestaurantStatus(restaurantId);
        } else {
          Swal.fire({
            icon: "error",
            title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!",
            text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ",
            confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
          });
        }
      })
      .catch(error => {
        console.error("Error:", error);
        Swal.fire({
          icon: "error",
          title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!",
          text: "‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
          confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
        });
      });
    }

    function checkRestaurantStatus(restaurantId) {
      if (!restaurantId) return;
      $.ajax({
        url: `/api/check-restaurant-status/${restaurantId}`,
        method: "GET",
        success: function (data) {
          if (data.isClosed) {
            $("#restaurant-status").html("‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô üî¥");
            $("#toggle-status-btn").text("‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô");
          } else {
            $("#restaurant-status").html("‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô üü¢");
            $("#toggle-status-btn").text("‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô");
          }
        },
        error: function () {
          console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ");
        }
      });
    }
  </script>
</body>
</html>
