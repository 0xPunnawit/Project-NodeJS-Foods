<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="/css/receive-orders.css" rel="stylesheet">
    <title>
        <%= title %>
    </title>
</head>

<body>
    <%- include('../partials/navbar') %>
        <br>

        <main class="container mt-5">
            <h3 class="text-center mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h3>

            <div class="mb-3">
                <label class="form-label"><strong>üìå ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</strong></label>
                <div class="d-flex flex-wrap gap-3">
                    <!-- Checkbox ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filterAll" checked>
                        <label class="form-check-label fw-bold" for="filterAll">üìã ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    </div>
            
                    <!-- Checkbox ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
                    <div class="form-check">
                        <input class="form-check-input status-filter" type="checkbox" value="‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå" id="filterPending" checked>
                        <label class="form-check-label" for="filterPending">‚è≥ ‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input status-filter" type="checkbox" value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£" id="filterCooking" checked>
                        <label class="form-check-label" for="filterCooking">‚òÑÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input status-filter" type="checkbox" value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" id="filterReady" checked>
                        <label class="form-check-label" for="filterReady">‚úÖ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input status-filter" type="checkbox" value="‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" id="filterRejected" checked>
                        <label class="form-check-label" for="filterRejected">‚ùå ‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</label>
                    </div>
                </div>
            </div>
            
            
            <% if (orders.length===0) { %>
                <p class="text-center">‚õî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
                <% } else { %>

                    <!-- üì± Mobile View -->
                    <div class="order-list d-md-none">
                        <% orders.forEach((order)=> { %>
                            <div class="card mb-3">
                                <div class="card-header">
                                    <strong>‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: #<%= order.order_id %></strong>
                                    <span id="status-<%= order.order_id %>" class="badge 
                                <%= order.order_status === '‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' ? 'bg-warning' :
                                    order.order_status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£' ? 'bg-info' :
                                    order.order_status === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' ? 'bg-success' :
                                    'bg-danger' %>">
                                        <%= order.order_status %>
                                    </span>
                                </div>
                                <div class="card-body">
                                    <p><strong>‡πÄ‡∏°‡∏ô‡∏π:</strong>
                                        <%= order.items %>
                                    </p>
                                    <p><strong>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> <%= order.note ? order.note : '-' %></p>

                                    <select class="form-select status-dropdown" data-order-id="<%= order.order_id %>">
                                        <option value="‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"
                                            <%=order.order_status==="‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå" ? "selected" : "" %>
                                            >‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</option>
                                        <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£" <%=order.order_status==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£" ? "selected"
                                            : "" %>>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                        <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" <%=order.order_status==="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"
                                            ? "selected" : "" %>>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                                        <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" <%=order.order_status==="‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" ? "selected"
                                            : "" %>>‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                                    </select>
                                    <button class="btn btn-primary mt-2 w-100"
                                        onclick="fetchOrderDetails('<%= order.order_id %>')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                                </div>
                            </div>
                            <% }); %>
                    </div>

                    <!-- Table View (Desktop) -->
                    <div class="table-container d-none d-md-block">
                        <table class="table table-striped text-center">
                            <thead class="table-dark">
                                <tr>
                                    <th>‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
                                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÄ‡∏°‡∏ô‡∏π & ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
                                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
                                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% orders.forEach((order)=> { %>
                                    <tr>
                                        <td>#<%= order.order_id %>
                                        </td>
                                        <td>
                                            <%= order.items %>
                                        </td>
                                        <td><%= order.note ? order.note : '-' %></td>

                                        <td>
                                            <span id="status-<%= order.order_id %>" class="badge 
                                        <%= order.order_status === '‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' ? 'bg-warning' :
                                            order.order_status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£' ? 'bg-info' :
                                            order.order_status === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' ? 'bg-success' :
                                            'bg-danger' %>">
                                                <%= order.order_status %>
                                            </span>
                                        </td>
                                        <td>
                                            <select class="form-select status-dropdown"
                                                data-order-id="<%= order.order_id %>">
                                                <option value="‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"
                                                    <%=order.order_status==="‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå" ? "selected" : "" %>
                                                    >‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</option>
                                                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£" <%=order.order_status==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£"
                                                    ? "selected" : "" %>>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                                <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" <%=order.order_status==="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß"
                                                    ? "selected" : "" %>>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                                                <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" <%=order.order_status==="‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò"
                                                    ? "selected" : "" %>>‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                                            </select>
                                        </td>
                                        <td>
                                            <button class="btn btn-primary btn-sm"
                                                onclick="fetchOrderDetails('<%= order.order_id %>')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                    </div>

                    <% } %>
        </main>
        <script>
            $(document).ready(function () {

                let currentOrderCount = <%= orders.length %>; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
                let orderSound = new Audio("/sounds/new-order.mp3"); // ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô

                // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
                $(document).on("click", function () {
                    orderSound.muted = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                });

                function checkNewOrders() {
                    $.ajax({
                        url: "/vendor/get-order-count", // API ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                        method: "GET",
                        success: function (response) {
                            if (response.success) {
                                if (response.count > currentOrderCount) {
                                    playOrderSound(); // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                                    currentOrderCount = response.count; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
                                }
                            }
                        },
                        error: function () {
                            console.error("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ");
                        }
                    });
                }

                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                function playOrderSound() {
                    if (!orderSound.muted) {
                        orderSound.currentTime = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
                        orderSound.play().catch(error => console.error("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ:", error));
                    }
                }
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setInterval(checkNewOrders, 3000);

                $(document).on("change", ".status-dropdown", function () {
                    const orderId = $(this).data("order-id");
                    const newStatus = $(this).val();
                    const dropdown = $(this);
                    const statusElement = $(`#status-${orderId}`);
                
                    console.log(`üü¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${orderId} ‡πÄ‡∏õ‡πá‡∏ô: ${newStatus}`);
                
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô reset
                    localStorage.setItem(`order-${orderId}`, newStatus);
                
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (PC ‡πÅ‡∏•‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
                    statusElement.text(newStatus);
                    updateStatusColor(orderId, newStatus);
                
                    // ‡∏™‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
                    $.ajax({
                        url: `/vendor/update-order-status/${orderId}`,
                        method: "POST",
                        data: { new_status: newStatus }
                    }).done(function () {
                        console.log(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö #${orderId}`);
                
                        Swal.fire({
                            icon: "success",
                            title: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!",
                            showConfirmButton: false,
                            timer: 1500
                        });
                
                        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô dropdown ‡∏ñ‡∏π‡∏Å reset ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                        setTimeout(() => {
                            statusElement.text(newStatus);
                            updateStatusColor(orderId, newStatus);
                        }, 300);
                
                    }).fail(function () {
                        console.log(`‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö #${orderId}`);
                
                        Swal.fire({
                            icon: "error",
                            title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!",
                            text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ",
                            confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á"
                        });
                
                        // ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ dropdown ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
                        dropdown.val(localStorage.getItem(`order-${orderId}`) || statusElement.text());
                    });
                });
                
            });

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà)
            function updateStatusColor(orderId, newStatus) {
                const statusElement = $(`#status-${orderId}`);
                statusElement.removeClass("bg-warning bg-info bg-success bg-danger text-white");

                if (newStatus === "‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå") {
                    statusElement.addClass("bg-warning");
                } else if (newStatus === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£") {
                    statusElement.addClass("bg-info text-white");
                } else if (newStatus === "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß") {
                    statusElement.addClass("bg-success text-white");
                } else if (newStatus === "‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò") {
                    statusElement.addClass("bg-danger text-white");
                }
            }

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
            function formatThaiDate(dateString) {
                if (!dateString) return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
                const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.",
                    "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

                const date = new Date(dateString);
                if (isNaN(date.getTime())) return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ"; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î

                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543} ‡πÄ‡∏ß‡∏•‡∏≤ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            }

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            function fetchOrderDetails(orderId) {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                $.ajax({
                    url: `/vendor/order-details/${orderId}`,
                    method: "GET"
                }).done(function (response) {
                    Swal.close();
                    if (response.success) {
                        let order = response.order;
                        let items = response.items || [];

                        if (items.length === 0) {
                            Swal.fire({
                                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                text: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ',
                                icon: 'error',
                                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                            });
                            return;
                        }

                        let itemsHtml = items.map(item => `
                        <tr>
                            <td>${item.menu_name}</td>
                            <td>${item.menu_option_name || '-'}</td>
                            <td>${item.quantity}</td>
                            <td>‡∏ø${parseFloat(item.total_item_price).toFixed(0)}</td>
                        </tr>
                    `).join("");

                        Swal.fire({
                            title: `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${orderId}`,
                            html: `
                        <p><strong>üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${order.customer_name}</p>
                        <p>(‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${order.customer_tel})</p>
                        <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</strong> ${formatThaiDate(order.created_at)}</p>
                        <p><strong>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${response.note ? response.note : '-'}</p> <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
                        <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ table-responsive -->
                        <div class="table-responsive">
                            <table class="table table-bordered mt-3">
                                <thead>
                                    <tr>
                                        <th>‡πÄ‡∏°‡∏ô‡∏π</th>
                                        <th>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
                                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                        <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
                                    </tr>
                                </thead>
                                <tbody>${itemsHtml}</tbody>
                            </table>
                        </div>
                        `,
                            icon: 'info',
                            confirmButtonText: '‡∏õ‡∏¥‡∏î'
                        });

                    } else {
                        Swal.fire({
                            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ',
                            icon: 'error',
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                        });
                    }
                }).fail(function () {
                    Swal.fire({
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ',
                        icon: 'error',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                });
            }

            $(document).ready(function () {
                function filterOrders() {
                    let selectedStatuses = $(".status-filter:checked").map(function () {
                        return $(this).val();
                    }).get();
            
                    $(".order-list .card, .table-container tbody tr").each(function () {
                        let orderStatus = $(this).find(".badge").text().trim();
                        if (selectedStatuses.includes(orderStatus) || selectedStatuses.length === 0) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
            
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß ‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
                    if ($(".status-filter:checked").length === $(".status-filter").length) {
                        $("#filterAll").prop("checked", true);
                    } else {
                        $("#filterAll").prop("checked", false);
                    }
                }
            
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏≠‡∏±‡∏ô
                $("#filterAll").change(function () {
                    $(".status-filter").prop("checked", $(this).prop("checked"));
                    filterOrders();
                });
            
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î checkbox ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡πä‡∏Å "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                $(".status-filter").change(function () {
                    filterOrders();
                });
            
                // üîÑ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                filterOrders();
            });
            
            

            let currentOrderCount = 0; // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà

            function refreshOrderList() {
                $.ajax({
                    url: "/vendor/get-latest-orders",
                    method: "GET",
                    success: function (response) {
                        console.log("üì° [DEBUG] ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å API:", response);
                        if (response.success) {
                            let orderListHtml = '';
                            let newOrderCount = response.orders.length;
            
                            response.orders.forEach(order => {
                                let savedStatus = localStorage.getItem(`order-${order.order_id}`) || order.order_status;
            
                                orderListHtml += `
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <strong>‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: #${order.order_id}</strong>
                                            <span id="status-${order.order_id}" class="badge 
                                                ${savedStatus === '‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' ? 'bg-warning' :
                                                    savedStatus === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£' ? 'bg-info' :
                                                    savedStatus === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' ? 'bg-success' :
                                                    'bg-danger'}">
                                                ${savedStatus}
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>‡πÄ‡∏°‡∏ô‡∏π:</strong> ${order.items}</p>
                                            <p><strong>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${order.note}</p>
                                            <select class="form-select status-dropdown" data-order-id="${order.order_id}">
                                                <option value="‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå" ${savedStatus === "‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå" ? "selected" : ""}>‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</option>
                                                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£" ${savedStatus === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£" ? "selected" : ""}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                                                <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" ${savedStatus === "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" ? "selected" : ""}>‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                                                <option value="‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" ${savedStatus === "‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" ? "selected" : ""}>‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                                            </select>
                                            <button class="btn btn-primary mt-2 w-100" onclick="fetchOrderDetails('${order.order_id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                                        </div>
                                    </div>`;
                            });
            
                            $(".order-list").empty().append(orderListHtml);
            
                            if (newOrderCount > currentOrderCount) {
                                playOrderSound();
                            }
            
                            currentOrderCount = newOrderCount;
                        }
                    },
                    error: function () {
                        console.error("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ");
                    }
                });
            }
            
            // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏∏‡∏Å 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setInterval(refreshOrderList, 15000);
            
            
        </script>

</body>

</html>