<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <link href="/css/order-detail.css" rel="stylesheet">
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>
</head>

<body>
  <%- include('partials/navbar') %>
  <br>
  <div class="container mt-5">
    <div class="card order-detail-card shadow">
      <div class="card-body">
        <h2 class="text-center mb-4">üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>

        <h5><i class="fa-solid fa-store"></i> ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: <strong><%= order.restaurant_name %></strong></h5>
        <p><i class="fa-solid fa-receipt"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: <strong>#<%= order.order_id %></strong></p>

        <hr>

        <h5>üõí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</h5>
        <ul class="list-group">
          <% items.forEach(item => { %>
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong><%= item.menu_name %></strong> (<%= item.quantity %>x)
        
                  <div class="text-muted">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡∏ô‡∏π: <%= item.base_price %> ‡∏ö‡∏≤‡∏ó</div> <!-- ‡πÉ‡∏ä‡πâ price ‡∏à‡∏≤‡∏Å menu_items -->
        
                  <% if (item.menu_option_name !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å') { %>
                    <div class="text-muted">‚ûï <%= item.menu_option_name %> (+<%= item.option_price %> ‡∏ö‡∏≤‡∏ó)</div>
                  <% } else { %>
                    <div class="text-muted">‚ûï ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                  <% } %>
        
                  <div class="text-muted">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å): <%= item.item_price %> ‡∏ö‡∏≤‡∏ó</div>
                </div>
                <div>
                  <span class="text-success">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <%= item.total_item_price %> ‡∏ö‡∏≤‡∏ó</span>
                </div>
              </div>
            </li>
          <% }); %>
        </ul>
        
        
        <hr>

        <p class="total-price"><strong>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> <%= order.total_price %> ‡∏ö‡∏≤‡∏ó</p>
        <p><strong>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> <%= note %></p>

        <p><strong>üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå:</strong> 
          <span id="order-status" class="badge 
            <% if (order.order_status === '‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå') { %> bg-warning text-dark
            <% } else if (order.order_status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£') { %> bg-primary
            <% } else if (order.order_status === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') { %> bg-success
            <% } else if (order.order_status === '‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò') { %> bg-danger <% } %>
          ">
            <%= order.order_status %>
          </span>
        </p>

        <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á:</strong> 
          <%= new Date(order.created_at).toLocaleDateString('th-TH', { 
              day: '2-digit', 
              month: 'long', 
              year: 'numeric', 
              hour: '2-digit', 
              minute: '2-digit', 
              hour12: false 
          }) %>
        </p>

        <div class="text-center mt-4">
          <a href="/orders" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
          </a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function refreshOrderStatus() {
      const orderId = <%= order.order_id %>; // ‡πÉ‡∏ä‡πâ order_id ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      
      fetch(`/api/order-status/${orderId}?timestamp=${new Date().getTime()}`) // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cache
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const statusElement = document.querySelector("#order-status");
  
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
            if (statusElement && statusElement.textContent.trim() !== data.order_status.trim()) {
              console.log(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Order ${orderId} -> ${data.order_status}`);
  
              statusElement.textContent = data.order_status;
  
              // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏•‡∏≤‡∏™‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
              statusElement.className = "badge";
  
              switch (data.order_status) {
                case "‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå":
                  statusElement.classList.add("bg-warning", "text-dark");
                  break;
                case "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£":
                  statusElement.classList.add("bg-primary");
                  break;
                case "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß":
                  statusElement.classList.add("bg-success");
                  break;
                case "‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò":
                  statusElement.classList.add("bg-danger");
                  break;
                default:
                  statusElement.classList.add("bg-secondary"); // ‡∏Å‡∏±‡∏ô Error ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å
              }
            }
          }
        })
        .catch(error => console.error("Error fetching order status:", error));
    }
  
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    setInterval(refreshOrderStatus, 5000);
  </script>
  


</body>
</html>
