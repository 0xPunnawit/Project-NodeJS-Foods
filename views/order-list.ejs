<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="/css/order-list.css" rel="stylesheet">
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</title>
</head>

<body>
    <%- include('partials/navbar') %>
  <br>
    <div class="container mt-5 pt-3">
      <h2 class="text-center mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>

  
      <% if (orders.length > 0) { %>
        <% orders.forEach(order => { %>
          <div class="card order-card mb-3 shadow-sm" id="order-<%= order.order_id %>" data-order-id="<%= order.order_id %>">
            <div class="card-body">
              <h3 class="card-title">
                <i class="fa-solid fa-receipt"></i> ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: <strong>#<%= order.order_id %></strong>
              </h3>

              <h5 class="card-title">
                <i class="fa-solid fa-store"></i> ‡∏£‡πâ‡∏≤‡∏ô: <strong><%= order.restaurant_name %></strong>
              </h5>

              <p class="card-text">
                <strong>üõí ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á:</strong>
                <% order.items.forEach((item, index) => { %>
                  <%= item.menu_name %> (<%= item.quantity %>x)<%= index < order.items.length - 1 ? ", " : "" %>
                <% }) %><br>
                <strong>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> <%= order.total_price %> ‡∏ö‡∏≤‡∏ó<br>
                <strong>üì¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå:</strong>
                <span class="badge order-status 
                  <% if (order.order_status === '‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå') { %> bg-warning text-dark
                  <% } else if (order.order_status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£') { %> bg-primary
                  <% } else if (order.order_status === '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') { %> bg-success
                  <% } else if (order.order_status === '‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò') { %> bg-danger <% } %>
                ">
                  <%= order.order_status %>
                </span>
                <br>
                <small class="text-muted">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:
                  <%= new Date(order.created_at).toLocaleDateString('th-TH', { 
                      day: '2-digit', 
                      month: 'long', 
                      year: 'numeric', 
                      hour: '2-digit', 
                      minute: '2-digit', 
                      hour12: false 
                  }) %>
                </small>
              </p>
              <a href="/order/<%= order.order_id %>" class="btn btn-outline-primary btn-sm">
                <i class="fa-solid fa-eye"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </a>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="alert alert-info text-center">
          <p>üõí ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
          <a href="/restaurant" class="btn btn-primary"><i class="fa-solid fa-store"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</a>
        </div>
      <% } %>
    </div>
  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function refreshOrderStatus() {
            document.querySelectorAll(".order-card").forEach((order) => {
                const orderId = order.dataset.orderId;
    
                fetch(`/api/order-status/${orderId}?timestamp=${new Date().getTime()}`) // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cache
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const orderElement = document.querySelector(`#order-${orderId} .order-status`);
                            
                            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                            if (orderElement && orderElement.textContent.trim() !== data.order_status.trim()) {
                                console.log(`üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Order ${orderId} -> ${data.order_status}`);
    
                                orderElement.textContent = data.order_status;
                                
                                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏•‡∏≤‡∏™‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                                orderElement.className = "badge order-status";
    
                                switch (data.order_status) {
                                    case "‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå":
                                        orderElement.classList.add("bg-warning", "text-dark");
                                        break;
                                    case "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£":
                                        orderElement.classList.add("bg-primary");
                                        break;
                                    case "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß":
                                        orderElement.classList.add("bg-success");
                                        break;
                                    case "‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò":
                                        orderElement.classList.add("bg-danger");
                                        break;
                                    default:
                                        orderElement.classList.add("bg-secondary"); // ‡∏Å‡∏±‡∏ô Error ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å
                                }
                            }
                        }
                    })
                    .catch(error => console.error("Error fetching order status:", error));
            });
        }
    
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(refreshOrderStatus, 5000);
    </script>
    

  </body>

</html>
